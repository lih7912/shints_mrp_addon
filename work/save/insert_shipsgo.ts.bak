const { MongoClient } = require('mongodb');
const path = require('path');
const fs = require('fs');

var request_sync = require('sync-request');
var rp = require('request-promise');
const multiparty = require('multiparty');
var amqp = require('amqplib/callback_api');
var iconv = require('iconv-lite');

import { Prisma } from "@prisma/client";
import prisma from "./db";  //PrismaClient 사용하기 위해 불러오기
import AFLib from "./commlib";  //PrismaClient 사용하기 위해 불러오기

const process1 = async(argPuCd:string) => {

    var tRetDate: string = AFLib.getCurrTime();
    var tRetDate1: string = tRetDate.substring(0, 8);

    var sqlBL_NO : string =  `
            select bl_no, ship_line, isnull(tracking_id , '') as tracking_id
            from ksv_blno_mst
    `;
    var objBL_NO : any[]  =  await prisma.$queryRaw(Prisma.raw(sqlBL_NO));

    var tIdx :number = 0; 
    var tArray = [];
    var tBlNo = '';
    var tShipLine = '';
    var tTrackingId = '';
    for (tIdx = 0; tIdx < objBL_NO.length; tIdx++) {
        var tOne : Object  = { ...objBL_NO[tIdx] };

        console.log(`=======================================================`);
        console.log(`>>>>> (1) ${tOne['bl_no']} | ${tOne['ship_line']} | ${tOne['tracking_id']} `);

        tBlNo = tOne['bl_no'];
        tShipLine = tOne['ship_line'];
        tTrackingId  = tOne['tracking_id'];

        if (tTrackingId === '') {

            var myJSONObject : Object  = {};
            myJSONObject['authCode'] = 'ea8cef24345326b30a7446b461608d14';
            myJSONObject['shippingLine'] = tShipLine;
            myJSONObject['blContainersRef'] = tBlNo;

            var res_sync = request_sync('POST', 'https://shipsgo.com/api/v1.1/ContainerService/PostContainerInfoWithBl', {
              json: myJSONObject,
            });
            var tRequestId : string = JSON.parse(res_sync.getBody('utf8'));
            console.log(`>>>>> (2) ${tBlNo} | ${tShipLine} | ${tRequestId} `);

            if (tRequestId !== '')  {
                var sqlUpdate : string =  `
                    update ksv_blno_mst set tracking_id = '${tRequestId}'
                    where bl_no = '${tBlNo}' and ship_line = '${tShipLine}'
                `;
                var objUpdate : any  =  await prisma.$queryRaw(Prisma.raw(sqlUpdate));
                console.log(`>>>>> (21) ${tBlNo} | ${tShipLine} | ${tRequestId} `);
            }
        } else {
            var tUrl  = `https://shipsgo.com/api/v1.1/ContainerService/GetContainerInfo/?authCode=ea8cef24345326b30a7446b461608d14&requestId=${tTrackingId}&mapPoint=true`;
            var res_sync = request_sync('GET', tUrl);
            var tResData = JSON.parse(res_sync.getBody('utf8'));

            var tData0 =  { ...tResData[0] };
            var tA_ETA = tData0['ETA'];
            var tF_ETA = tData0['FirstETA'];
            var tSHIP_STATUS = tData0['Status'];

            var tStr = `${tA_ETA}|${tF_ETA}|${tSHIP_STATUS}|`;

            var tData1 =  { ...tData0['LoadingDate'] };
            var tLOADING_DATE = tData1['Date'];
            tStr += tLOADING_DATE + '|';

            tData1 =  { ...tData0['DepartureDate'] };
            var tDEPARTURE_DATE = tData1['Date'];
            tStr += tDEPARTURE_DATE + '|';

            tData1 =  { ...tData0['ArrivalDate'] };
            var tARRVAL_DATE = tData1['Date'];
            tStr += tARRVAL_DATE + '|';

            tData1 =  { ...tData0['DischargeDate'] };
            var tDISCHARGE_DATE = tData1['Date'];
            tStr += tDISCHARGE_DATE + '|';

            console.log(`>>>>> (3) ${tBlNo} | ${tShipLine} | ${tTrackingId} | ${tStr} `);
            console.log(`>>>>> (30) ${tA_ETA} | ${tF_ETA} | ${tSHIP_STATUS} | ${tLOADING_DATE} `);
            console.log(`>>>>> (30) ${tDEPARTURE_DATE} | ${tARRVAL_DATE} | ${tDISCHARGE_DATE} | ${tRetDate} `);

            var sql0 = `
                update ksv_blno_mst set
                  A_ETA = '${tA_ETA}' ,
                  F_ETA = '${tF_ETA}' ,
                  SHIP_STATUS = '${tSHIP_STATUS}' ,
                  LOADING_DATE = '${tLOADING_DATE}' ,
                  DEPARTURE_DATE = '${tDEPARTURE_DATE}' ,
                  ARRVAL_DATE = '${tARRVAL_DATE}' ,
                  DISCHARGE_DATE = '${tDISCHARGE_DATE}' ,
                  UPD_DATETIME = '${tRetDate}' ,
                  GATEOUT_DATE = ''
                where bl_no = '${tBlNo}'
            `;
            var tRet0 = await prisma.$queryRaw(Prisma.raw(sql0));
            console.log(`>>>>> (31) ${tBlNo} | ${tShipLine} | ${tTrackingId} | ${tStr} `);
        }
    }

}

var tPuCd = process.argv[2];
process1(tPuCd);

